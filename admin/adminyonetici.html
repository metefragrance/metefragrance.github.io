<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8">
<title>Mete Fragrance ‚Äì Admin Panel</title>

<style>
body{
  background:#0e0e0e;
  color:#fff;
  font-family:Arial, sans-serif;
  padding:24px;
}
input,button,select,label{
  width:100%;
  padding:10px;
  margin:8px 0;
  background:#000;
  color:#fff;
  border:1px solid #333;
}
button{cursor:pointer}
pre{
  background:#000;
  padding:12px;
  white-space:pre-wrap;
}
.box{
  border:1px solid #222;
  padding:16px;
  margin-bottom:22px;
}
.count{
  font-size:22px;
  font-weight:bold;
}
</style>
</head>

<body>

<!-- DASHBOARD -->
<div class="box">
  <h3>üìä Dashboard</h3>
  <div>Toplam √úr√ºn: <span class="count" id="total">‚Äì</span></div>
  <div>Shopier Linkli: <span class="count" id="shopier">‚Äì</span></div>
</div>

<!-- √úR√úN EKLE -->
<div class="box">
  <h3>‚ûï √úr√ºn Ekle</h3>
  <input id="t" placeholder="GitHub Token (classic)">
  <input id="n" placeholder="√úr√ºn Adƒ±">
  <input id="p" placeholder="Fiyat">
  <input id="i" placeholder="Resim URL">
  <input id="l" placeholder="Shopier Link">
  <label>
    <input type="checkbox" id="badge"> √úr√ºn Rozeti (Yeni)
  </label>
  <button id="addBtn">√úR√úN EKLE</button>
</div>

<!-- √úR√úN Sƒ∞L -->
<div class="box">
  <h3>üóëÔ∏è √úr√ºn Sil</h3>
  <select id="productSelect">
    <option>√úr√ºnler y√ºkleniyor‚Ä¶</option>
  </select>
  <button id="delBtn">SE√áƒ∞LEN √úR√úN√ú Sƒ∞L</button>
</div>

<pre id="log">Hazƒ±r</pre>

<script>
const OWNER = "metefragrance";
const REPO  = "metefragrance.github.io";

/* ===== √úR√úNLERƒ∞ INDEX.HTML'DEN √áEK ===== */
async function loadProducts(){
  const res = await fetch("/index.html?ts=" + Date.now());
  const html = await res.text();

  const doc = new DOMParser().parseFromString(html,"text/html");
  const cards = [...doc.querySelectorAll(".card")];

  // Dashboard
  total.textContent = cards.length;
  shopier.textContent =
    cards.filter(c => c.href && c.href.includes("shopier.com")).length;

  // Select doldur
  productSelect.innerHTML = "";
  cards.forEach(card=>{
    const name =
      card.querySelector(".title")?.innerText.trim() ||
      card.getAttribute("data-name") ||
      card.href;

    const opt = document.createElement("option");
    opt.value = card.href;   // silme anahtarƒ±
    opt.textContent = name;
    productSelect.appendChild(opt);
  });

  if(!cards.length){
    productSelect.innerHTML = "<option>√úr√ºn yok</option>";
  }
}

/* ===== SAYFA A√áILINCA ===== */
loadProducts();

/* ===== √úR√úN EKLE ===== */
addBtn.onclick = async () => {
  const res = await fetch(
    `https://api.github.com/repos/${OWNER}/${REPO}/dispatches`,
    {
      method: "POST",
      headers:{
        "Accept":"application/vnd.github+json",
        "Content-Type":"application/json",
        "Authorization":"Bearer " + t.value.trim()
      },
      body: JSON.stringify({
        event_type: "add",
        client_payload:{
          name: n.value,
          price: p.value,
          img: i.value,
          link: l.value,
          badge: badge.checked ? "Yeni" : ""
        }
      })
    }
  );

  log.textContent =
    "ADD STATUS: " + res.status + "\n" +
    ((await res.text()) || "(204 ise normal)");

  setTimeout(loadProducts, 2000);
};

/* ===== √úR√úN Sƒ∞L ===== */
delBtn.onclick = async () => {
  if(!productSelect.value){
    alert("√úr√ºn se√ß");
    return;
  }

  const res = await fetch(
    `https://api.github.com/repos/${OWNER}/${REPO}/dispatches`,
    {
      method: "POST",
      headers:{
        "Accept":"application/vnd.github+json",
        "Content-Type":"application/json",
        "Authorization":"Bearer " + t.value.trim()
      },
      body: JSON.stringify({
        event_type: "delete",
        client_payload:{ link: productSelect.value }
      })
    }
  );

  log.textContent =
    "DELETE STATUS: " + res.status + "\n" +
    ((await res.text()) || "(204 ise normal)");

  setTimeout(loadProducts, 2000);
};
</script>

</body>
</html>
